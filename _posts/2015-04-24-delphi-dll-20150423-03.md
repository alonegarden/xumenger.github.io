---
layout: post
title: Delphi之DLL知识学习3---为什么要使用DLL
categories: delphi之dll
tags: delphi dll 编译 链接
---


使用DLL有若干理由，其中有一些前面提到过的。大体说来，使用动态链接库可以共享代码、系统资源，可以隐藏实现的代码或底层的系统例程、设计自定义控件

## 一、共享代码、资源和数据

前面已经提到，共享代码是创建动态链接库的主要目的所在。但与单元的代码共享不同，DLL的代码可以被任何Windows 应用程序共享，而单元代码的工现象局限于Delphi应用程序

另外，DLL提供了共享资源的途径，诸如 位图、字体、图标等等这些都可以放到一个资源文件中，并直接链接到应用程序。如果把这些资源放到DLL中，那么就可以让许多引用程序使用，而不必在内存中重复装入这些资源。

在16位的Windows 中，DLL有自己的数据段，于是，所有要调用同一个DLL的应用程序能够访问同一个全局变量和静态变量。但是在Win 32系统中，这就不同了。因为DLL的映像被映射到每个进程的地址空间，该DLL的所有数据属于映射到的进程。值得一说的是，尽管进程间不能共享DLL的数据，但是同一个进程的所有线程可以共享，因为线程是相互独立的，所以在访问某一DLL的全局变量时，务必小心，防止引起冲突。

一定要理解：如果有多个程序都去加载同一个DLL，那么每个程序都会在自己的内存空间里面复制一份DLL（或者说：DLL的映像被映射到每个进程的地址空间），不会是多个程序共用一个DLL，所以多个加载DLL的程序需之间不会因为都加载一个DLL而有任何的联系和冲突（可能也有一些很特殊的情况下会造成冲突，那时候就需要注意了，不过目前我还没有了解到，等到以后遇到了再去整理吧！）。大家都是将DLL复制到自己的内存空间，然后各自执行各自的。

但是这并不意味着没有办法实现在进程间共享一个DLL的数据。一个技术可以通过内存映射文件的方法在内存中创建一个共享的区域。一切需调用DLL的应用程序都可以读这些存储在内存中的共享区域中的数据

 
## 二、隐藏实现的细节

有时候，你可能想隐藏例程实现的细节，DLL就可以实现这一点，不管为什么要隐藏你的代码，DLL可以使函数被应用程序访问，而其中的代码细节不被显现，你所要做的只是提供别人能访问DLL的接口。你也许认为Delphi的便于单元（DCU）也可以实现隐藏细节，但是DCU只适用于Delphi应用程序，而且还受版本的局限。而DLL与语言无关，所以，创建的DLL可以被C++、VB或者其他支持DLL的语言调用。

Windows单元是Win32 DLL的接口单元。Delphi 5提供了Win32 API的源文件，其一是Windows单元的源文件windows.pas，在该文件的interface部分有如下的定义：

    function ClientToScreen(Hwnd: HWND; var lpPoint: TPoint): BOOL; stdcall;

为连接到相应的DLL，在其implementation部分，有如下的例子：

    function ClientToScreen; external user32 name 'ClientToScreen';

这行代码的意思表明，ClientToScreen() 在动态链接库 User32.dll中，它的名称叫 ClientToScreen

 
## 三、自定义控件

自定义控件通常放在DLL中。这些控件不同于Delphi的自定义组件。自定义控件是在Windows 下注册，并且可以在任何Windows开发环境中使用。将这些类型的自定义控件加进DLL中，是考虑到即使有多个应用程序要使用这些自定义控件，内存中也只有该控件的一份实例

注意：其实将自定义控件加入到DLL这种机制已经过时，现在微软使用 OLE和ActiveX控件自定义控件已经很少见了