---
layout: post
title: 开发时（多线程）的资源管理策略
categories: 深入学习之多线程 深入学习之内存管理
tags: 多线程 内存 内存管理 
---

## 开发时一些资源的管理策略

在程序开发的时候，有时候需要使用一个大的内存缓冲区去使用。一般的方法是一次申请、多次使用、使用完再最后释放

因为需要防止出现大内存块的反复申请和释放导致的速度很慢；也是防止大内存块和小内存块同时反复申请和释放，而出现内存碎片的现象

同样的，一个类的对象最好也是创建一次，反复使用，再释放

如果总是创建一次、使用一次后就释放，等到下次需要的实时再创建一次、然后又是使用一次后就释放……这样浪费了太多的时间在对象的创建和释放上了

内存的申请和释放、对象的创建和释放是比较慢的，很影响性能的

## 反思一下自己最新开发的一个项目

说到性能，就以最近我开发的一个项目讲一下自己开发中代码不规范的地方

我的项目是需要从系统的数据库中读取信息，写到DBF文件中，今天做了一个简单的测试，往DBF中写数据的速度也就是达到100条/s

首先是这个任务本身的需求造成的，有这样一些限制条件：需要保证每个DBF中的数据最多有1000条，另外要求同一个DBF中不允许有两条数据的字段1和字段2是相同的，结果因为很多的数据的字段1和字段2是相同的，所以往往会出现这样的情况，也就是在程序运行的时候需要为每份数据先创建一个DBF，再将数据写到DBF中，所以这样就可能会很慢

估计的原因有如下几个，也是需要重点优化的地方

* 需要频繁的创建DBF文件，导致程序运行的性能受到影响（现在改成拷贝DBF，估计也是很慢的。这个需要自己写个简单的demo进行专门的测试和统计）
* 程序运行中，反复打开关闭DBF，这部分的操作也是很慢的。
* 还有就是比如反复创建和释放TDBF对象

补充，需要研究TDBF的代码实现：

* 另外弄清楚我使用的那个操作DBF文件的类（我们公司自己实现的一个类，就叫做TDBF类吧）的对象打开DBF后是独占的，还是通过行级锁的形式
* 应该是行级锁的形式，每处理哪行就对哪行加锁，这样的话，就可以一直打开，直到真正需要关闭的时候再关闭
* 同时去扩展研究数据库的锁机制

所以，可以采取的优化对策有

* 首先因为需求的要求和接口的规范，拷贝出新的DBF的操作这部分暂时是没有办法进行修改和优化的，但是其他部分还是可以去优化的
* 最好是可以创建一个TDBF对象之后，一直使用它，可以使用它打开DBF文件1，操作完之后，关闭DBF文件1，再去打开和操作DBF文件2，直到操作完关闭它……就这样反复使用创建好的TDBF对象，直到最后不再使用了再去释放
* 想想最好不要反复打开和关闭DBF文件，因为TDBF的对象操作DBF文件的时候不是使用独占的方式，而是使用加行级锁的方式，所以可以一直打开，它会且只会给正在操作的行加锁，这就不会产生多线程或者多进程同时操作一个DBF文件时出现冲突的问题！

## 多线程环境下资源得到管理的策略

多线程环境下，可能需要申请多块内存缓冲区，以线程号作为Key来对应每块内存，然后以线程号--内存首地址的对应关系，放到一个list中，每个线程需要使用的时候，根据线程号，在list中找到自己的内存块，就不会出现多线程访问同一块内存的冲突了

同理，像其他的资源，比如：数据库连接对象等都可以这样来做

还有一点，就是这样根据线程号创建的资源，创建一次，每个线程获取的时候，如果已经创建了这个线程对应的资源，就直接获取，如果没有创建，那么创建好，并且和线程号对应好，放到一个链表，这样就可以每个线程拥有自己的资源，另外就是这种方式创建好的资源，就放在线程里，等到不需要的时候再放回链表，这样就不需要反复创建了，直到最后真正不需要的时候，再进行释放

本周我开发了一个新的项目，因为时间很紧，所以可能为了赶进度，就只是专注于功能的实现，但是在周五开发完之后，最近两天再看自己的程序，里面的程序细节有很多不规范的地方：对象的频繁创建和释放、DBF文件频繁的打开和关闭

显然对象的创建和释放太频繁是一个很影响性能的点，需要考虑一个好的对象管理的方式，好创建一次，一直使用，直到最后真正不用的时候在释放

不要随便创建和释放对象、不要随意申请和释放内存

---

资源是很宝贵的，能省则省！！！！
