---
layout: post
title: 好的异常处理策略
categories: delphi之异常处理 软件质量之稳定性
tags: delphi 异常处理
---

## 日后补充

* Add in 2016-03-04：目前在下面整理的只是怎么进行异常处理，但是还是不够完善
  * 还没有考虑到哪些异常需要提示出来、哪些异常不进行提示
  * 因为有的异常是偶发的，程序本身可以容忍的并且程序自己完全可以应对的，出现的话可以在内部处理好但是不要提醒出来，比如通过网络获取交易所行情信息，假如偶尔一次因为网络丢包出现异常，但是因为后续的循环可以继续更新，那么这种偶发性的错误就直接在内部处理、内部记录，但是不展示给用户
  * 但是有的异常是导致任务运行的必要的前提条件都不满足的，那么这种必须报错交给用户去处理，比如假如一个任务要读写数据库，但是如果数据库都没有配置，那么显然不是任务本身就可以应付的了的，必须报错交由用户进行处理
  * 需要考虑用户体验层面，程序本身可以解决掉的异常就不要提醒给用户

## 开始正文

在之前的博客中详细的介绍了Delphi的异常处理得当代码逻辑、异常处理的各方面的知识，详见下面的链接

* [再看Delphi的异常处理](http://www.xumenger.com/delphi-except-20160116/)
* [Delphi异常处理时代码的执行逻辑](http://www.xumenger.com/delphi-exception-20151201/)
* [总结一下最近开发遇到的问题，以及最近需要学习的知识点](http://www.xumenger.com/learn-plan-20151123/)
* [Delphi中的异常处理](http://www.xumenger.com/delphi-exception-20150428/)
* [Delphi中的异常处理](http://www.xumenger.com/delphi-exception/)

但是一直有一个问题，就是等到自己真正在开发一个项目的时候，具体要怎么应用异常处理就没有好的策略了，尤其是开发一个持续运行的软件项目，更需要进行充分的、合理的异常处理，以保证在遇到意外情况的时候任务（一般是持续运行的线程）不意外终止，能够合理的处理异常并且继续运行。经过长时间的开发实践，加上自己很笨的脑袋的思考，总结出一套简单的在开发中进程异常处理的原则，两者需要结合才能最大化的保证软件项目的质量

## 笼统性的异常处理

一般的场景是这样的，线程要持续运行，其实线程方法都是一个循环，而且循环中可能有多重循环，循环1内部会有另一层循环2……

**好的规范是在每一层循环内都先包一个try...except异常处理的逻辑**。

这就是是笼统的捕获和处理异常，因为只是简单的在一个循环中做一个异常处理，并不能精确是在循环的什么地方出现的异常。但是这样做已经是一个很好的软件质量的保证了，可以保证异常不导致线程循环的异常结束，保证线程不因为异常而被意外的结束。

这一层笼统的异常处理是一定要做的！

## 精确的异常处理

怎么进行精确的异常处理，以Delphi开发为例，其实所有的语言都是一样的原则：在一些容易出现异常的代码逻辑出进行针对性的异常处理

下面列出一些常见的异常，但是只是一部分，还有很多容易出现异常的地方会在后续的开发中更多的遇到，也会持续的补充

* 比如打开DBF文件可能是一个容易出现异常的地方
  * 多说一句，为了保证少出现打开DBF出现异常的情况，最好是打开一次，持续使用，到最后不用时再关闭
  * 这样一方面可以减少频繁打开关闭可能导致出现打开DBF的异常，而可以避免反复打开关闭DBF的性能浪费
* 格式化如`Format('my name is %6s',['wind']);` 是可能因为类型不对应而出现异常的地方
* 连接数据库的地方容易出现异常
* 执行SQL或者调用存储过程的地方
* 网络连接、网络通信的代码逻辑处可能出现网络连接异常等异常
* 按照一定的格式规范解析数据包的时候也是可能出现异常的地方，比如正在解析的包格式是不对的，那么解析包可能就会抛出异常。比如XML的解析、某种约定好格式的网络包或者其他包文的解析，一旦出现字符串的格式有不符合约定格式的就会出现异常
* 还有比如`StrToInt`，如果执行`I := StrToInt('aa')`，则会抛出异常
  * 不过可以不使用`try..except`捕获异常的方式，而使用`I := StrToIntDef(字符串, 默认整数)`的方式，比如`I := StrToIntDef('aa', 1)`
  * `StrToFloat`也建议写成`StrToFloatDef`的方式
* 等等很多具体的可能出现异常的地方需要进行针对性的异常处理

## 最重要的还是自己的灵活运用

上面的我个人整理出来的，在目前的情况下适用于我自己的一个简单的异常处理的原则。但是细想想就算是计算机原理层面的很多概念都在完善和进化，所以像这种完全是个人在开发中的经验总结，要说很有用确实很有用，但是要说没有用可能就是一段废话的累计而已

具体怎么进行异常处理、怎么保证自己的软件项目的质量，说到底还是要在自己对软件工程、对异常处理的原理和逻辑本身有个很深入的理解之后，然后在具体编程的时候结合自己的项目的特点、结合每一段代码逻辑的特点，（以Delphi为例）灵活的运用`try..except`、`try..finally`，或者是两者的配合，当然还有除了异常处理之外的更多要注意的保证自己项目质量的点，试想如果哦对于内存管理、多线程同步等没有一个基本的理解，只是知道这些异常处理额技巧，又能怎么样呢？！

## 题外话

* 纯粹是举个例子，我，一个刚进入股票市场的人，去试着买一手股票，报价100元，但是没法报单，提示说：“超过本只股票的涨停价，不允许报单”，这时候一般人可能会想到问一下：“涨停价是多少？”
* 既然问到涨停价是多少了（比如知道了涨停价是95），为什么不去再往深了问一层：“什么是涨停价？”
* 既然问到了什么是涨停价（知道了在中国股票市场每天的股票的价格是有一个限制的，这就是涨跌停价），为什么不再去深入的问一层：“涨停价的规则是什么样的？”
* 既然到了涨跌停的规则是什么（普通股票限制当天涨跌幅不超过开盘价的10%），那为什么不再去往深了问一层：“为什么要限制在10%？”
* 再深入问一层：“为什么港股市场、美国市场都没设涨跌停限制，为什么只有我国有这个特殊的规则？从经济学原理层面到底怎么解释这个问题？”
* 如此循环，然后继续一层一层往深了问、往深了探究、钻研
* 直到最后真的刨根问底，真正将根本的原因弄清楚了
* 很多人就可能问到第一层，然后最多慢慢直到了涨跌停的规则是10%，但是后面为什么设置涨跌停，为什么设置在10%的限制，就没有去弄清楚
* 所以很多人永远浮于表面，永远只知其然，整天忙忙碌碌的收集这些表面的知识，但是也有人每次都刨根问底，将几个问题的根本原因弄清楚之后，再去看其他的问题就一般可以做到举一反三了，就不需要受困于将这些表层的肤浅的知识再去死记硬背了
* 对于业务知识、对于技术知识都是这个道理！试着一层一层往里问，试着往深了多想一层！不要只是知其然就停止了
* 最简单的检查自己对一个问题和知识的理解程度够不够就是，反问自己：“如果一个对这个概念不懂的人来问我，我能不能组织一套语言给他将清楚，如果他一直刨根问底，我又能不能针对他的每个疑惑做出合理的解答？如果不能，那就是自己的理解程度还不够”
