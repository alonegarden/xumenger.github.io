---
layout: post
title: 理解Windows消息
categories: delphi之消息机制 windows之消息机制
tags: delphi windows 消息机制 消息系统
---

>直接通过看《DELPHI 5 开发人员指南》学习以下的知识内容

尽管VCL组件可以通过 Object Pascal事件来响应Win 32消息，但是，作为一个Win 32程序员，理解Windows 的消息系统还是非常必要的。

作为一个 Delphi应用程序开发者，你将发现，在大部分情况下使用 VCL的事件就已经足够了，只有少数情况才需要深入到 Win32消息处理的世界。然而，作为一个 Delphi组件开发者，你将和消息成为好朋友，因为你不得不直接处理许多 Windows消息。

## 什么是消息

消息，就是指Windows发出的一个通知，告诉应用程序某个事情发生了。例如：单击鼠标、改变窗口尺寸、按下键盘上的一个键都会使 Windows发送一个消息给应用程序。

消息本身是作为一个记录传递给应用程序的，这个记录中包含了消息的类型以及其他信息。例如：对于单击鼠标所产生的消息来说，这个消息中包含了单击鼠标时的坐标。这个记录类型叫做TMsg，它在Windows单元中是这样声明的：

```
type
  TMsg = packed record    //带packed关键字的结构体表明编译器编译该结构体时不需要进行字对齐
    hwnd: HWDN;			//窗口句柄
    message: UNIT;		//消息常量标识符
    wParam: WPARAM;		//32位消息的特定附加信息
    lParam: LPARAM;		//32位消息的特定附加信息
    time: DWORD;		//消息创建时的时间
    pt: TPoint;			//消息创建时的鼠标位置
  end;
```

消息中有什么？

* hwnd：32位的窗口句柄。窗口可以是任何类型的屏幕对象，因为Win32能够维护大多数可视对象的句柄（窗口、对话框、按钮、编辑框等）
* message：用于区别其他消息的常量值，这些常量可以是Windows单元中预定义的常量，也可以是自定义的常量
* wParam：通常是一个与消息有关的常量值，也可能是窗口或控件的句柄。
* lParam：通常是一个指向内存中数据的指针。由于wParam、lParam和Pointer都是32位的，因此，它们之间可以相互转换

## 消息的类型

Win32中预定义了一些消息常量。消息常量由TMsg记录的message域来传递。这些常量是在Messages单元中定义的。消息常量往往是以字母WM打头，代表Windows Message，下面是一些常用的Windows消息以及它们的含义和值

* WM_ACTIVE---$0006---窗口被激活或被取消
* WM_CHAR---$0102---按下某个键，并且已经发送了 WM_KEYDOWN和WM_KEYUP消息
* WM_CLOSE---$0010---窗口将要关闭
* WM_KEYDOWN---$0100---按下一个键
* WM_KEYUP---$0101---按键被释放
* WM_LBUTTONDOWN---$0201---按下鼠标左键
* WM_MOUSEMOVE---$0200---鼠标移动
* WM_PAINT---$000F---窗口的客户区需要重画
* WM_TIMER---$0113---发生了定时器事件
* WM_QUIT---$0012---程序将要退出

## Windows消息系统是如何工作的

Windows的消息系统由3个部分组成：

* **消息队列**：Windows能够为所有的应用程序维护一个消息队列。应用程序必须从消息队列中获取消息，然后分派给某个窗口
* **消息循环**：通过这个循环机制，应用程序从消息队列中检索消息，再把它分派给适当的窗口，然后继续从消息队列中检索下一条消息，再分派给释放的窗口，依次进行
* **窗口过程**：每个窗口都有一个窗口过程来接收传递给窗口的消息，它的任务就是获取消息然后响应它。**窗口过程是一个回调函数**，处理一个消息后，它通常要返回一个值给Windows

一个消息从产生到被一个窗口响应，其中有5个步骤：

1. 系统发送了某个事件
2. Windows把这个事件翻译为消息，然后把它放到消息队列中
3. 应用程序从消息队列中接收这个消息，把它存放在TMsg记录中
4. 应用程序把消息传递给一个适当的窗口的窗口过程
5. 窗口过程响应这个消息并进行处理

步骤3和4构成了应用程序的**消息循环**。消息循环往往是 Windows应用程序的核心，因为消息循环使一个应用程序能够响应外部的事件。消息循环的任务就是从消息队列中检索消息，然后把消息传递给适当的窗口。如果消息队列中没有消息，Windows就允许其他应用程序处理它们的消息。
