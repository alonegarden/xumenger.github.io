---
layout: post
title: 设计一个简单的自动化测试框架
categories: 项目管理之测试
tags: 测试 自动化 程序质量 项目管理 抽象 输入 输出 delphi dll 耦合 内聚 解耦
---

最近到上海出差帮助上交所测试新接口，本来以为只是简单的测试接口是不是可以调用成功就可以了，所以就做了一个简单的需要人工输入、点击、发送报文的工具。结果到了交易所，人家却希望我们做一个自动化测试的工具：可以在工具上维护各种场景对应的测试用例，可以自动化运行所有这些测试用例，然后展示测试结果。一脸懵逼，一方面是之前开发的工具基本上没有什么用了，另一方面是这个工作主要涉及到的是测试、自动化测试领域的知识，而我也只不过是看过2、3本关于测试的书籍而已，从来没有实际操作过

>这也反映了软件行业一直存在的一个问题：一开始没有弄清楚客户的真实需求，到设计那里、再到开发那里将会导致大量的返工

不过既然人家提了需求，那硬着头皮也得做出来：先去了解什么是自动化测试、自动化测试的策略是什么样的，再去一步步的自己设计实现

>正好也一直想了解测试和自动化测试，挺好的一个机会！

## 什么是自动化测试

首先什么是测试？

>按照我的个人理解就是，输入一个测试数据（或者是通过手动点击按钮的方式、或者是通过表单的方式、或者是程序内部调用函数的入参），得到一个输出结果（或者是可视化的界面展示、或者是调用函数的出参），然后将输出结果与预期的结果进行对比，如果一致则说明测试通过，否则说明测试未通过。当然也需要考虑预期本身是错误的可能性！

那么测试的重点是什么？

>是否能将所有的场景都测试到？每个字段的每种可能值是不是都测试到了？对于各个字段的各个边界值是否重点测试了？是否测试了对于不合法的输入程序会有怎样的处理和输出？从输入到最终输出的中间每一层的子输入和子输出是不是都测试到了？

就我们公司而言，目前主要是手工测试的方式，手工输入信息、手工检查输出结果。但正因为是手工的方式，而且毕竟是人，总有会出现很多问题

>最简单的，如果有n个字段，每个字段有m个值域，那么至少需要维护m^n个测试用例才能将所有情况都覆盖到。这个公式只对一层逻辑有效，而实际的项目架构中，从输入到最终的输出，中间往往也会经历多层的子输入和子输出，那么情况就变得更加复杂了

所以想要纯粹通过人工来控制这么大的复杂度确实是很难很难的！

什么是自动化测试？参考[《在做自动化测试之前你需要知道的》](http://www.cnblogs.com/fnng/p/3653793.html)

>广义上来讲，自动化包括一切通过工具（程序）的方式来代替或辅助手工测试的行为，包括性能测试工具（loadrunner、jmeter），或自己所写的一段程序，用于生成1~100个测试数据。狭义上来讲，通过工具记录或编写脚本的方式模拟手工测试的过程，通过回放或运行脚本来执行测试用例，从而代替人工对系统的功能进行验证。而且自动化测试可以重复执行，所以在进行回归测试时有天生的优势

>自动化测试，其实和单元测试有些类似，单元测试的目的是可以一次写，多次运行，对于测试驱动以及后期维护真是有非常多的好处，用自动化测试工具也是如此，主要的目的是为了回归测试；单元测试时，要先准备好数据，再测试，最后再进行数据清理，自动化测试也是如此

最简单的将计算机进行抽象就是：输入-->处理-->输出。但这个模型所涵盖的领域和维度太多，小至调用一个函数的输入到输出；大到一个普通的用户在网站上填写表单，中间经过前端处理、网络传输、后台逻辑处理、数据库处理，再原路返回，呈现给用户的输出

在《Google测试之道》一书中提到，比较好的测试投入比例应该是：70%的投入在单元测试，20%的投入在集成和接口测试，10%的投入在UI层的自动化测试。而单元测试主要是开发人员在编写功能代码同时使用单元测试框架（比如Java的JUnit、Python的unittest等）编写对应的单元测试代码，所以最好是开发人员自己来做主要的测试

>在软件开发中，从需求，到设计，到开发，到测试，越往后出现需求变更，那么成本就越大。对应在测试领域，越往上层，投入的成本越高，所以应该把更多的自动化测试放在单元测试和接口测试阶段，而不是在UI测试阶段

## 没有绝对的好，只有相对的适合

按照上面的描述，给人感觉自动化测试就是完美，而手工测试就是一无是处，而实际并不是这样。一个东西既然存在就有它存在的原因！对于测试来说，有些领域确实使用自动化测试可以更快、更少出错，但是有些场景还是必须使用手工测试

>自动化测试有它适用的场景；手工测试也有它所适用的场景

自动化测试，需要测试人员开发测试脚本、编写测试用例，同样也需要使用SVN、Git等版本控制工具来进行管理，所以这将会是一个周期很长的工作。如果对应的软件项目是一个周期很短的工程，那么也就没有充分的时间去设计和编写自动化测试，这时候可能手工测试会更适用

自动化测试有一个很大的要求就是一次性维护好测试用例后，可以重复执行，在回归测试中有很大的用武之地。如果某个项目需求今天变，明天变，那么工程代码需要根据需求进行变化，同样的自动化测试的代码、脚本、用例也处于一直变化当中，自动化代码、脚本本身也是程序，还需要进行调试、优化的工作。明显会花费很多的维护成本，如果发现这样维护自动化测试的成本比手工测试高，那么还不如一开始就做手工测试。毕竟在一个企业中，哪管你技术牛不牛逼，能省钱、能挣钱才是王道

自动化测试毕竟是机器来做的，所以它只能按照测试人员编写的脚本、测试用例去被动的执行，所以自动化测试的质量完全依赖于测试人员编写的脚本、测试用例的质量。而开发出来的程序最终是要给到用户使用的，一个具体人去使用软件，就会有人的各种想法、操作方式，就会出现各种状况，而机器是没有想象力的，所以很多“莫名其妙”的场景可能根本做不到（除非测试人员真的很厉害，各种“神奇”的场景都对应写了脚本、写了用例），所以还是有必要将自动化测试和手工测试结合起来使用的

自动化测试最终还是要由人来设计和编写，所以还是要求测试人员自己有很强的测试能力、技术能力、对业务的理解能力

>总的来说，自动化测试还只是适用于那种大量、复杂、无脑、重复劳动的场景，这也正是计算机可以帮助人类解脱出来的领域

了解自动化测试工具、自动化测试的操作逻辑，建议阅读[《在做自动化测试之前你需要知道的》](http://www.cnblogs.com/fnng/p/3653793.html)、[《QTP之delphi试用感想一（自动化测试）》](http://www.cnblogs.com/findumars/p/5995196.html)

## 如何设计和开发一个简单的自动化测试框架

经过以上的描述，可以把计算机程序抽象成：输入-->处理-->输出。对应的软件测试就可以抽象为：输入-->输出-->检查输出结果

比如对于手工测试，需要在测试之前编写测试用例，将各种可能的场景都尽可能的考虑到，通过文档或者其他的测试用例管理工具，将一个个用例的场景、输入、预期结果描述清楚，然后开始按照这份文档逐个手动测试，将实际得到的输出结果和预期结果进行对比

软件有多种多样的形式，有可视化的网页，有供其他开发者调用的接口、有后台业务处理逻辑等各种各样的形式。与之对应的，测试的模式也是多种多样的。虽然同为输入和输出，但其形式上千差万别，可视化网页的输入可能要靠点击控件，输出是页面的跳转；API函数的输入是入参，输出则是出参和返回值……

针对测试工作的特点，如何将测试过程自动化？

* 先使用Excel或者类似的工具维护好各种用例
* 用例的格式是：输入信息、预期输出
* 然后自动化测试工具将输入信息打包传给被测试对象
* 被测试对象将输出信息传给自动化测试工具
* 自动化测试工具将实际输出信息和预期输出进行对比，判断是否测试成功

如果针对专门的测试对象做一个测试工具，那么可用性太差，就像上面提到的，不同的被测试对象其输入输出的逻辑和形式会有很大的差别，所以想想能不能做一个自动化测试的框架，将所有被测试对象的共同点即输入和输出抽象出来，然后每个被测试对象可以通过开发插件的方式来编写对应的自动化测试实现

大概产生如下的设计方案：

* 做一个自动化测试框架，不和任何具体的被测试对象有逻辑上的耦合
* 每个被测试对象可以通过为自动化测试框架开发对应的插件来进行测试
* 使用Excel或者类似的工具来管理测试用例，每一行是一个测试用例
* 自动化测试框架将测试用例的输入信息打包后，传给DLL的导出函数
* DLL必须实现两个导出函数：初始化函数、测试输入输出的函数、释放资源函数供框架调用
* DLL内部调用被测试对象，得到输出结果，然后打包传给框架
* 框架再将得到的XML输出信息解包，将解包后的各个字段对应放到Excel或类似工具对应行的对应列
* 框架同时将得到的实际输出和维护的预期输出对比，得到测试结果
* 框架将测试结果的详细信息以HTML或其他的方式输出，最终将所有测试用例执行完就可以得到一份详细的测试报告
* 这里为了框架实现的方便，输入输出必须是同步的
* Excel的第一列是FuncNo字段，表示对应DLL内部要调用哪个功能号
* Excel中列名为in\_开头的，将作为入参被打包传入DLL
* Excel中列名为out\_开头的，在得到DLL的XML输出后，解析XML将对应字段写到Excel对应的列
* Excel中列明为want\_开头的，是维护的预期输出结果，和out\_一一对应，方便框架对比

上面说到必须以同步模式输入输出，当然插件开发者完全可以自己实现异步模式

* 框架将输入给到DLL，DLL内部处理，然后随便给个输出
* 实际DLL内部可能是多线程方式异步得到结果，比如很多网络接口就是异步发送和接收的
* 然后DLL内部将实际的输出结果导入到某个专门的Excel或类似工具
* 对应的，在测试前，维护好一份预期输出结果
* 最终用DLL内部输出的Excel或其他工具来和这份预期结果进行对比
* 那么自动化测试工具在这里只是一个自动化调用的功能，对比结果可能要插件开发者自己实现了

上面说到的输入和输出使用XML格式，并且设计为单层的XML，这样框架实现起来更方便呢

* 当然如果插件需要多层的包结构，也是可以实现的
* 比如为各个节点做一个特殊的命名，再在DLL插件内部根据命名转成多层的包结构
* 比如网络传输中可能会应用到多层的XML，或多层的JSON，或多层的FIX

通过为该框架开发插件，大概可以测试以下类型的软件接口

* 最简单的就是测试函数、类接口的输入、输出
* 插件DLL实现一个同步发送接收的客户端，来测试服务端的通信接口。比如实际客户端和服务端需要使用FIX格式的包，那么插件内部的实现逻辑是将框架传过来的XML包解析，转换成FIX，发送给服务器，收到服务器的FIX包，解析FIX包再转换成XML格式返回给框架
* 等等

而以上的模式就几乎包含了软件接口的绝大多数了

>框架将输入输出接口规定为XML格式，插件内部将XML输入转换成被测试对象的接口形式，然后插件再将被测试对象的输出转成XML格式给框架，如此一来框架就完全将输入、输出抽象出来，和具体的被测试对象的接口形式完全解耦，具备良好的可扩展性

## 参考资料和文章

* [《在做自动化测试之前你需要知道的》](http://www.cnblogs.com/fnng/p/3653793.html)
* [《自动化测试总结（一）》](http://blog.csdn.net/star890124/article/details/48311347)
* [《自动化测试总结（二）》](http://blog.csdn.net/star890124/article/details/48311361)
* [《QTP之delphi试用感想一（自动化测试）》](http://www.cnblogs.com/findumars/p/5995196.html)

## 补充

**add in 2016-12-30**

经过几天的自动化测试，发现自动化测试真的没有想象的那么方便，自动化本身的调试也是很费工夫的事情

不过当自动化测试全部通过之后，后续使用它来进行回归测试确实就方便多了
