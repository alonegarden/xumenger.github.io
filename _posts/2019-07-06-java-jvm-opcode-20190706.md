---
layout: post
title: Java虚拟机与指令集
categories: java之内存管理 深入学习之编译原理
tags: Java javac javap JVM 虚拟机与指令集 虚拟机 指令集 
---

编写一个简单的Java 程序如下

```java
package com.test;

public class OpCode {
    private int m;
    public String str;

    public int function(int i, String s) {
        this.m = i;
        this.str = s;

        if (i > 0) {
            System.out.println("测试判断");
        }

        while (i > 0) {
            System.out.println("测试循环: " + str);
            i--;
        }

        return m + m;
    }
}
```

编译Java 程序，然后直接看.class 文件内容

![](../media/image/2019-07-06/01.png)

然后使用javap -verbose OpCode.class 查看.class 内容如下

```
Classfile /Users/xumenger/Desktop/code/Java/opcode/OpCode.class
  Last modified 2019-7-6; size 778 bytes
  MD5 checksum 26b433c4df122c28db3014237e71b3d2
  Compiled from "OpCode.java"
public class com.test.OpCode
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #13.#27        // java/lang/Object."<init>":()V
   #2 = Fieldref           #12.#28        // com/test/OpCode.m:I
   #3 = Fieldref           #12.#29        // com/test/OpCode.str:Ljava/lang/String;
   #4 = Fieldref           #30.#31        // java/lang/System.out:Ljava/io/PrintStream;
   #5 = String             #32            // 测试判断
   #6 = Methodref          #33.#34        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #7 = Class              #35            // java/lang/StringBuilder
   #8 = Methodref          #7.#27         // java/lang/StringBuilder."<init>":()V
   #9 = String             #36            // 测试循环:
  #10 = Methodref          #7.#37         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
  #11 = Methodref          #7.#38         // java/lang/StringBuilder.toString:()Ljava/lang/String;
  #12 = Class              #39            // com/test/OpCode
  #13 = Class              #40            // java/lang/Object
  #14 = Utf8               m
  #15 = Utf8               I
  #16 = Utf8               str
  #17 = Utf8               Ljava/lang/String;
  #18 = Utf8               <init>
  #19 = Utf8               ()V
  #20 = Utf8               Code
  #21 = Utf8               LineNumberTable
  #22 = Utf8               function
  #23 = Utf8               (ILjava/lang/String;)I
  #24 = Utf8               StackMapTable
  #25 = Utf8               SourceFile
  #26 = Utf8               OpCode.java
  #27 = NameAndType        #18:#19        // "<init>":()V
  #28 = NameAndType        #14:#15        // m:I
  #29 = NameAndType        #16:#17        // str:Ljava/lang/String;
  #30 = Class              #41            // java/lang/System
  #31 = NameAndType        #42:#43        // out:Ljava/io/PrintStream;
  #32 = Utf8               测试判断
  #33 = Class              #44            // java/io/PrintStream
  #34 = NameAndType        #45:#46        // println:(Ljava/lang/String;)V
  #35 = Utf8               java/lang/StringBuilder
  #36 = Utf8               测试循环:
  #37 = NameAndType        #47:#48        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
  #38 = NameAndType        #49:#50        // toString:()Ljava/lang/String;
  #39 = Utf8               com/test/OpCode
  #40 = Utf8               java/lang/Object
  #41 = Utf8               java/lang/System
  #42 = Utf8               out
  #43 = Utf8               Ljava/io/PrintStream;
  #44 = Utf8               java/io/PrintStream
  #45 = Utf8               println
  #46 = Utf8               (Ljava/lang/String;)V
  #47 = Utf8               append
  #48 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;
  #49 = Utf8               toString
  #50 = Utf8               ()Ljava/lang/String;
{
  public java.lang.String str;
    descriptor: Ljava/lang/String;
    flags: ACC_PUBLIC

  public com.test.OpCode();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 3: 0

  public int function(int, java.lang.String);
    descriptor: (ILjava/lang/String;)I
    flags: ACC_PUBLIC
    Code:
      stack=3, locals=3, args_size=3
         0: aload_0
         1: iload_1
         2: putfield      #2                  // Field m:I
         5: aload_0
         6: aload_2
         7: putfield      #3                  // Field str:Ljava/lang/String;
        10: iload_1
        11: ifle          22
        14: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
        17: ldc           #5                  // String 测试判断
        19: invokevirtual #6                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        22: iload_1
        23: ifle          60
        26: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
        29: new           #7                  // class java/lang/StringBuilder
        32: dup
        33: invokespecial #8                  // Method java/lang/StringBuilder."<init>":()V
        36: ldc           #9                  // String 测试循环:
        38: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        41: aload_0
        42: getfield      #3                  // Field str:Ljava/lang/String;
        45: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        48: invokevirtual #11                 // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        51: invokevirtual #6                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        54: iinc          1, -1
        57: goto          22
        60: aload_0
        61: getfield      #2                  // Field m:I
        64: aload_0
        65: getfield      #2                  // Field m:I
        68: iadd
        69: ireturn
      LineNumberTable:
        line 8: 0
        line 9: 5
        line 11: 10
        line 12: 14
        line 15: 22
        line 16: 26
        line 17: 54
        line 20: 60
      StackMapTable: number_of_entries = 2
        frame_type = 22 /* same */
        frame_type = 37 /* same */
}
SourceFile: "OpCode.java"
```

## .class文件格式



## Java字节码



## 参考资料

* [C# IL指令速查](http://www.xumenger.com/csharp-il-20190630/)
* [JVM内存分配策略](http://www.xumenger.com/java-gc-memory-201903115/)
* [Java并发编程](http://www.xumenger.com/java-concurrency-20190211/)
* [Java杂谈](http://www.xumenger.com/talk-java-20180819/)
* [Java注解](http://www.xumenger.com/java-annotation-20181014/)
* [Java中的Class和Object](http://www.xumenger.com/java-class-object-20181009/)
* [图文详解 Java 字节码，想不懂都难！](https://www.jianshu.com/p/1d895401aecb)