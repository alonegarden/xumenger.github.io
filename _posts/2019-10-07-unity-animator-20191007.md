---
layout: post
title: Unity3D动画系统
categories: 游戏开发之unity
tags: Unity Unity3D 动画 Blender mixamo 罐头动画 骨骼 IK Animation Animator 动画控制器 烘焙 模型 fbx Layer 动画状态机 trigger 触发器 关键帧 帧 
---

在制作RPG 游戏的时候，实现各种流畅的动画效果是必不可少的，行走、奔跑、跳跃、砍杀、防御等等，而Unity3D 就提供了很强大的动画系统，下面跟随我去感受一下

>再次强调，下面展示的动画效果都是比较初级和简单的，要制作一个成熟的RPG 游戏，单动画状态机里面就可能存在数十种状态，如果管理这些状态也不是一件易事

## 动画的一些基础概念

在当前场景中新建一个Plane（平面），然后为其添加地砖贴图（使用贴图可以简单高效的做出很多中视觉效果），然后拖动一个模型到场景中，大概就是这个效果

![](../media/image/2019-10-07/01.png)

可以在Project 中看到模型的层级下有一个ybotAvatar，这就是模型的骨骼

![](../media/image/2019-10-07/02.gif)

还可以在骨骼编辑模式下通过骨骼为模型摆出各种动作、姿势

![](../media/image/2019-10-07/03.gif)

>建议去仔细研究一个模型的每一个骨骼，去尝试编辑一下骨骼！

在对应的动画文件的配置上，有一个Source 选项，这里选择的就是对应模型的骨骼

![](../media/image/2019-10-07/04.gif)

动画类型有四种：None（无动画）、Legacy（Animation动画）、Generic（通用型动画）、Humanoid（人型动画）

![](../media/image/2019-10-07/05.gif)

## 搭建简单场景

基于上面的简单场景，通过两个Cube 制作两个墙，墙中间放一个门

![](../media/image/2019-10-07/01-01.png)

![](../media/image/2019-10-07/01-02.gif)

为了区分门和墙，所以为墙添加一个简单的颜色材质

![](../media/image/2019-10-07/01-03.gif)

为了解决上面出现的门滑到墙里出现的渲染问题，可以将门的大小（Scale）设置的稍微比墙小一些

![](../media/image/2019-10-07/01-04.gif)

## 让模型动起来

为人物添加胶囊碰撞体和刚体，为了控制人物后续的碰撞等行为

![](../media/image/2019-10-07/02-01.gif)

为人物添加脚本，让人物可以通过键盘控制动起来（暂时不加动画效果）

```c#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class PlayerControl : MonoBehaviour
{
    // Start is called before the first frame update
    void Start()
    {
        
    }

    // Update is called once per frame
    void Update()
    {
        // 垂直轴
        float vertical = Input.GetAxis("Vertical");
        // 水平轴
        float horizontal = Input.GetAxis("Horizontal");
        // 方向向量
        Vector3 dir = new Vector3(horizontal, 0, vertical);
        if(dir != Vector3.zero)
        {
            // 旋转
            transform.rotation = Quaternion.LookRotation(dir);
            // 移动
            transform.Translate(Vector3.forward * 2 * Time.deltaTime);
        }
    }
}
```

>注意，比如一些行走动画，有的动画自带移动，有的动画只有行走的动作，但并不会真正产生位移！

运行效果如下

![](../media/image/2019-10-07/02-02.gif)

哎，为什么碰到墙之后就倒下了呢？需要为模型刚体固定旋转，然后就可以解决这个问题了

![](../media/image/2019-10-07/02-03.gif)

## 添加动画

人物可以动起来了，接下来我们就要添加动画，这里就简单的添加人物站立和走路的动画

首先我们看到这个人物是自带Animator 组件的，但是没有动画控制器

![](../media/image/2019-10-07/03-01.gif)

所以接下来要创建一个Animator Controller，专门给这个人物使用

![](../media/image/2019-10-07/03-02.gif)

但是现在是没有任何效果的，接下来就要为这个动画控制器编辑动画状态机，就如前面所说，只有站立和行走两个状态

![](../media/image/2019-10-07/03-03.gif)

默认就是进入Idel 状态，现在不修改代码，直接运行的效果是这样的

![](../media/image/2019-10-07/03-04.gif)

为什么人飞起来了？找到对应的动画，去【Inspector】-->【Animation】中进行设置

![](../media/image/2019-10-07/03-05.gif)

然后优化代码如下

```c#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class PlayerControl : MonoBehaviour
{
    private Animator anim;

    // Start is called before the first frame update
    void Start()
    {
        anim = GetComponent<Animator>();
    }

    // Update is called once per frame
    void Update()
    {
        // 垂直轴
        float vertical = Input.GetAxis("Vertical");
        // 水平轴
        float horizontal = Input.GetAxis("Horizontal");
        // 方向向量
        Vector3 dir = new Vector3(horizontal, 0, vertical);
        if(dir != Vector3.zero)
        {
            // 旋转
            transform.rotation = Quaternion.LookRotation(dir);
            // 移动
            transform.Translate(Vector3.forward * 2 * Time.deltaTime);
            // 播放行走动画
            anim.SetBool("walk", true);
        }
        else
        {
            // 播放站立动画
            anim.SetBool("walk", false);
        }
    }
}
```

现在人物在站立和行走的时候就会有动感话效果了

![](../media/image/2019-10-07/03-06.gif)

还有一个问题，为什么当人物运行起来的时候没有立马播放行走动画呢，因为少勾选了【Has Exit Time】，所以不能实现随时切换到下一个动画，必须是等当前动画播放完才能播放下一个动画，重新配置一下之后

![](../media/image/2019-10-07/03-07.gif)

## 自动门


然后

>根据这个思路，我们可以实现各种效果，比如游戏中的机关、电梯、陷阱等等

## 