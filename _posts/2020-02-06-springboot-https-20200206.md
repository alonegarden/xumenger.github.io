---
layout: post
title: SpringBoot搭建HTTPS服务
categories: 深入学习之网络原理 网络安全之web安全
tags: HTTP Web HTTPS 网络协议 安全 SSL TCP 超文本传输协议 加密 证书 CA证书 对称加密 非对称加密 公钥 私钥 SpringBoot Spring Java 网络安全 
---

关于HTTP 和HTTPS 协议，之前在[HTTP与HTTPS协议](http://www.xumenger.com/https-20190217/) 简单介绍过

1. 客户端使用https 的URL 访问Web 服务器，要求与Web 服务器建立SSL 连接
2. Web 服务器收到客户端请求后，会将网站的证书信息（包含公钥）传送一份到客户端
3. 客户端与Web 服务器开始协商SSL 连接的安全等级，也就是信息加密的等级
4. 客户端根据双方同意的安全等级，建立会话秘钥，然后利用网站的公钥将会话秘钥加密，并传送给网站
5. Web 服务器利用自己的私钥解密出会话秘钥
6. Web 服务器利用会话秘钥加密与客户端之间的通信

![](../media/image/2020-02-06/01.gif)

## SpringBoot搭建HTTPS服务

在[阿里云平台](https://www.aliyun.com/product/cas?spm=5176.10695662.1171680.2.286f720f7nlNMo&aly_as=hbJTFCvT)申请SSL 证书！

测试使用，直接申请免费证书即可

![](../media/image/2020-02-06/02.png)

申请的时候可能需要你在阿里云有购买过域名，另外提交申请后，需要等一段时间后查看申请结果

![](../media/image/2020-02-06/03.png)

审核通过后，下载证书，对应选择tomcat，下载到本地后解压得到这样的文件，.pfx是证书文件、pfx\_password.txt 是证书文件的密码

![](../media/image/2020-02-06/04.png)

将.pfx 复制到SpringBoot 项目的resources 目录下，然后在application.properties 中添加配置内容

```
# https
server.ssl.key-store=classpath:3431309_xumenger.com.pfx
server.ssl.key-store-password=8Bnf0hUn
server.ssl.key-store-type=PKCS12
server.port=443
```

然后新增HttpConfig 类

```java
package com.cmb.order;

import org.apache.tomcat.util.descriptor.web.SecurityCollection;
import org.apache.tomcat.util.descriptor.web.SecurityConstraint;
import org.apache.catalina.Context;

import org.springframework.boot.context.embedded.EmbeddedServletContainerFactory;
import org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainerFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class HttpsConfig {
    @Bean
    public EmbeddedServletContainerFactory servletContainer() {
        TomcatEmbeddedServletContainerFactory tomcat = new TomcatEmbeddedServletContainerFactory() {
            @Override
            protected void postProcessContext(Context context) {
                SecurityConstraint constraint = new SecurityConstraint();
                constraint.setUserConstraint("CONFIDENTIAL");
                SecurityCollection collection = new SecurityCollection();
                collection.addPattern("/*");
                constraint.addCollection(collection);
                context.addConstraint(constraint);
            }
        };
        return tomcat;
    }
}
```

启动之后，会发现这个报错

![](../media/image/2020-02-06/05.png)

临时解决方案是将端口设置为4443

```
# https
server.ssl.key-store=classpath:3431309_xumenger.com.pfx
server.ssl.key-store-password=8Bnf0hUn
server.ssl.key-store-type=PKCS12
server.port=4443
```

然后重新启动后，在控制台可以看到HTTPS 服务已经成功启动

![](../media/image/2020-02-06/06.png)

比如我编写的这个Springboot 测试程序，现在可以通过[https://localhost:4443/order](https://localhost:4443/order) 去访问

![](../media/image/2020-02-06/07.png)

![](../media/image/2020-02-06/08.png)

## 如何编写HTTPS客户端访问



## 参考资料

* [Spring Boot 集成配置 HTTPS](https://www.bysocket.com/springboot/2386.html)
* [Spring Boot开发Web程序](http://www.xumenger.com/java-springboot-20180322/)
* [搭建Spring Boot源码环境](http://www.xumenger.com/spring-boot-eclipse-maven-20181201/)
* [从Spring到Spring Boot](http://www.xumenger.com/spring-ioc-20181206/)
