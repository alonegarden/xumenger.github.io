---
layout: post
title: Tomcat与Servlet原理
categories: java之web开发 java之web框架
tags: Java JVM Tomcat Jetty Servlet Socket HTTP TCP Web 网络编程 网络 SpringMVC SpringBoot 设计模式 
---

Servlet = Server + Applet

Applet 是Java 早期的一种技术，Java Applet 是一个客户端应用程序，可以运行在浏览器环境中，可以通过鼠标点击、操作

Servlet 则是相对于客户端的应用程序，它是服务端的应用程序，客户端通过网络请求来执行Servlet 的逻辑！

Servlet 是一个接口规范，在应用端要写一个应用程序，就要实现这个接口

>[Servlet3.1规范翻译](https://www.iteye.com/blogs/subjects/Servlet-3-1)

```java
package javax.servlet;

import java.io.IOException;

public interface Servlet {

    public void init(ServletConfig config) throws ServletException;

    public ServletConfig getServletConfig();

    public void service(ServletRequest req, ServletResponse res)
            throws ServletException, IOException;

    public String getServletInfo();

    public void destroy();
}
```

比如实现这个Servlet 接口的类有HttpServlet

## 一个简单的Servlet

编写一个Servlet 类

```java
public class TestServlet extends HttpServlet 
{
    public TestServlet(){
        super();
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {

        resp.setContentType("text/html");
        PrintWriter out = resp.getWriter();
        out.println("<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">");
        out.println("<HTML>");
        out.println("  <HEAD><TITLE>A Servlet</TITLE></HEAD>");
        out.println("  <BODY>");
        out.print("    This is ");
        out.print(this.getClass());
        out.println(", using the GET method");
        out.println("  </BODY>");
        out.println("</HTML>");
        out.flush();
        out.close();
    }
}
```

在web.xml 中增加Servlet 的定义

```xml
<servlet>
    <servlet-name>TestServlet</servlet-name>
    <servlet-class>TestServlet</servlet-class>
</servlet>
  
<servlet-mapping>
    <servlet-name>TestServlet</servlet-name>
    <url-pattern>/test</url-pattern>
</servlet-mapping>
```

例如项目名是test，运行Tomcat，打开浏览器访问地址 [http://127.0.0.1:8080/test/test](http://127.0.0.1:8080/test/test)，可以触发执行这个Servlet

最著名的一个Servlet，应该就是SpringMVC 框架中的DispatcherServlet，其继承树是这样的

![](../media/image/2020-10-01/01.png)

## HttpServletRequest类

在上面的例子中，doGet() 方法的一个参数是HttpServletRequest，是对一个HTTP 请求的封装

HttpServletRequest 其实是一个接口，但是其他程序调用这个doGet() 方法的时候一定是要传入HttpServletRequest 接口的实现类的，但是Servlet 规范只规定了这个接口，谁来实现这个接口呢？其实是由Servlet 容器实现！

而Tomcat 就是一个Servlet 容器实现！另外，Jetty 也是一个Servlet 容器实现！

可以理解Tomcat、Jetty 实现了Servlet 规范！

在tomcat 中，org.apache.catalina.connector.RequestFacade 实现了HttpServletRequest 接口；而jetty 则对应也有自己的实现！

org.apache.catalina.connector.RequestFacade 有一个属性是org.apache.catalina.connector.Request，这是一个典型的外观模式（Facade模式）的应用

## Tomcat架构图

本文主要参考[https://www.bilibili.com/video/BV1jJ41197va](https://www.bilibili.com/video/BV1jJ41197va)

![](../media/image/2020-10-01/02.png)

如上图展示了Tomcat 内部的层级关系图：Servlet -> Wrapper -> Context -> Host -> Engine

