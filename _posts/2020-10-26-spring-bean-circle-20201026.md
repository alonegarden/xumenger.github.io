---
layout: post
title: Spring 构造器循环依赖
categories: java之web开发 java之web框架 Spring之Ioc
tags: java bean IoC 循环依赖 Spring 容器 BeanCurrentlyInCreationException 
---

>参考《Spring技术内幕》、《Spring源码深度解析》

Spring 循环依赖一定是所有稍微深入了解了Spring 之后都会听到的一个知识点，也是大家所谓的面试问题热点

所谓循环依赖是指两个或多个Bean 相互地持有对方，比如A 引用B，B 引用C，C 引用A，最终反映为一个环

![](../media/image/2020-10-26/01.png)

Spring 容器循环依赖包括构造器循环依赖和setter 循环依赖。本文重点介绍构造器循环依赖，以及背后的原理

## 构造器循环依赖

即通过构造器注入构成的循环依赖，这种依赖是无法解决的，只能抛出BeanCurrentlyInCreationException 异常表示依赖

比如创建A的时候，构造器需要B，那么去创建B，创建B 的时又发现依赖C，再去创建C，但是创建C 又发现需要A，那么都无法完成创建

Spring 容器将每一个正在创建的Bean 标识符放在一个“当前创建Bean 池”中，Bean 标识符在创建过程中将一直保持在这个池中，因此如果在创建Bean 过程中发现自己已经在“当前创建Bean 池”里时，抛出BeanCurrentlyInCreationException；而对于创建完毕的Bean 将从“当前创建Bean 池”里清除掉

首先尝试去复现问题

```java
package com.xum.demo07;

public class ClassA {
    private ClassB b;
    
    public void a() {
    	b.b();
    }
    
    public ClassB getClassB() {
    	return b;
    }
    
    public void setClassB(ClassB b) {
    	this.b = b;
    }
}
```

```java
package com.xum.demo07;


public class ClassB {
    private ClassA a;
    
    public void b() {
    	a.a();
    }
    
    public ClassA getClassA() {
    	return a;
    }
    
    public void setClassA(ClassA a) {
    	this.a = a;
    }
}
```

```java
package com.xum.demo07;

import org.springframework.context.support.ClassPathXmlApplicationContext;

public class Test {

	@SuppressWarnings("resource")
	public static void main(String[] args) {
		new ClassPathXmlApplicationContext("beans07.xml");
	}
	
}
```

配置文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
    http://www.springframework.org/schema/mvc
    http://www.springframework.org/schema/mvc/spring-mvc-4.2.xsd
    http://www.springframework.org/schema/context
    http://www.springframework.org/schema/context/spring-context-4.2.xsd">
		
	<bean id="ClassA" class="com.xum.demo07.ClassA">
		<constructor-arg index="0" ref="ClassB"/>
	</bean>
	
	<bean id="ClassB" class="com.xum.demo07.ClassB">
		<constructor-arg index="0" ref="ClassA"/>
	</bean>
</beans>
```

运行之后，果然出现报错！

![](../media/image/2020-10-26/02.png)

其中BeanCurrentlyInCreationException 异常的信息如下

```
Caused by: org.springframework.beans.factory.BeanCurrentlyInCreationException: Error creating bean with name 'ClassA': Requested bean is currently in creation: Is there an unresolvable circular reference?
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.beforeSingletonCreation(DefaultSingletonBeanRegistry.java:347)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:219)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:318)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)
	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveReference(BeanDefinitionValueResolver.java:303)
	... 29 more
```